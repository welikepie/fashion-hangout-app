(function(){"use strict";_.templateSettings={interpolate:/(?:&lt;|<)!--!(.+?)!--(?:>|&gt;)/g,evaluate:/(?:&lt;|<)!--%(.+?)%--(?:>|&gt;)/g};var e,t,i,n,o,l,r,c,s,a,d;d=function(e,t){var i,n=document.createElement(e);if(t!==void 0&&null!==t)for(i in t)t.hasOwnProperty(i)&&n.setAttribute(i,t[i]);if(arguments.length>2)for(i=2;arguments.length>i;i+=1)"string"==typeof arguments[i]?n.innerHTML+=arguments[i]:"nodeType"in arguments[i]&&1===arguments[i].nodeType&&n.appendChild(arguments[i]);return n},e=Backbone.View.extend({container:null,template:null,initialize:function(e){var t,i,n=[_.pick(e,"collection","el")];Backbone.View.prototype.initialize.apply(this,n),"container"in e?"object"==typeof e.container?(this.container=e.container,this.$container=$(this.container)):"string"==typeof e.container&&$(e.container,this.el).length&&(this.$container=$(e.container,this.el).eq(0),this.container=this.$container[0]):(this.container=this.el,this.$container=this.$el),"template"in e?("object"==typeof e.template?(t=document.createElement("div"),$(e.template).remove().appendTo(t),t=t.innerHTML):t=e.template,i=_.template(t),this.template=function(e){var t=document.createElement("div");return t.innerHTML=i(e),t.removeChild(t.childNodes[0])}):this.template=function(){return document.createElement("div")}}}),t=Backbone.Model.extend({validate:function(e){return"id"in e&&"number"==typeof e.id&&e.id>=0?_.all(["name","description","poster"],function(t){return t in e&&"string"==typeof e[t]})?"sources"in e&&_.all(e.sources,function(e,t){return t.match(/^video\/[A-Za-z0-9]+$/)&&"string"==typeof e})?"outfit"in e&&e.outfit instanceof r?void 0:"Outfit is incorrect.":"Sources are incorrect.":"Text fields are incorrect.":"ID is incorrect."}}),i=Backbone.Collection.extend({model:t,comparator:"id",initialize:function(){Backbone.Collection.prototype.initialize.apply(this,arguments),this.on("reset",function(e){this.setCurrent(e.length>0?0:null)}),this.trigger("reset",this)},currentVideo:null,getCurrent:function(){return this.currentVideo},setCurrent:function(e){var t=this.currentVideo;if(null===e)this.currentVideo=null;else if("number"==typeof e)this.at(e)&&(this.currentVideo=this.at(e));else{if(!(e instanceof this.model))throw Error("Incorrect argument; needs to be either index or Video model.");this.contains(e)&&(this.currentVideo=e)}this.currentVideo!==t&&this.trigger("currentChanged",this.currentVideo)},prevVideo:function(){if(null===this.currentVideo)this.setCurrent(this.length-1);else{var e=this.indexOf(this.currentVideo)-1;0>e&&(e=this.length-1),this.setCurrent(e)}},nextVideo:function(){null===this.currentVideo?this.setCurrent(0):this.setCurrent((this.indexOf(this.currentVideo)+1)%this.length)}}),o=e.extend({initialize:function(t){if(!("collection"in t&&t.collection instanceof i))throw Error("Collection of type Playlist is required.");e.prototype.initialize.apply(this,arguments),this.listenTo(this.collection,"currentChanged",this.render),this.render()},render:_.debounce(function(){return this.$container.empty().append(this.collection.map(function(e){return $(this.template(e.toJSON())).on("click",this.collection.setCurrent.bind(this.collection,e)).get(0)}.bind(this))),this},10)}),n=Backbone.View.extend({feed:null,template:null,playlist:null,initialize:function(e){var t,i;if(Backbone.View.prototype.initialize.apply(this,[_.pick(e,"collection","el")]),!("feed"in e))throw Error("We need a feed!");"object"==typeof e.feed?(this.feed=e.feed,t=document.createElement("div"),$(e.feed).clone().remove().appendTo(t),t=t.innerHTML):t=e.feed,i=_.template(t),this.template=function(e){var t=document.createElement("div");return t.innerHTML=i(e),t.removeChild(t.childNodes[0])},"playlist"in e&&e.playlist instanceof o?(this.playlist=e.playlist,this.playlist.collection!==this.collection&&(this.playlist.collection=this.collection,this.playlist.render())):this.playlist=new o({collection:this.collection,el:$(document.createElement("div")).appendTo(this.el).get(0)}),this.listenTo(this.collection,"currentChanged",this.render)},render:_.debounce(function(){var e,t=this.collection.getCurrent();t?(e=this.template(t.toJSON()),$("video",e).on("ended",this.collection.nextVideo.bind(this.collection))):e=this.template({name:" ",description:"Click on any of the videos below to start the playback!",poster:"",sources:{}}),this.feed?$(this.feed).replaceWith(e):this.$el.prepend(e),this.feed=e},10)}),l=Backbone.Model.extend({validate:function(e){return"id"in e&&"number"==typeof e.id&&e.id>=0?_.all(["name","description","photo"],function(t){return t in e&&"string"==typeof e[t]})?void 0:"Text fields are incorrect.":"ID is incorrect."}}),r=Backbone.Collection.extend({model:l,comparator:"id"}),c=e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.collection instanceof r||(this.collection=new r)},render:_.debounce(function(){return this.$container.empty().append(this.collection.map(function(e){var t=this.template(e.toJSON());return $("a",t).on("click",this.trigger.bind(this,"addedToWishlist",e)),t}.bind(this))),this},10)}),s=e.extend({initialize:function(){e.prototype.initialize.apply(this,arguments),this.collection instanceof r||(this.collection=new r),this.listenTo(this.collection,"add remove reset",this.render)},render:_.debounce(function(){return this.$container.empty().append(this.collection.map(function(e){var t=this.template(e.toJSON());return $("a",t).on("click",function(){this.collection.remove(e)}.bind(this)),t}.bind(this))),this},10)}),a=Backbone.View.extend({video:null,catalogue:null,wishlist:null,initialize:function(e){if(!("collection"in e&&e.collection instanceof i))throw Error("Need a playlist.");if(Backbone.View.prototype.initialize.apply(this,[{el:document.getElementsByTagName("body")[0],collection:e.collection}]),!("video"in e&&e.video instanceof n))throw Error("We need a VideoFeed.");if(this.video=e.video,!("catalogue"in e&&e.catalogue instanceof c))throw Error("We need a Catalogue.");if(this.catalogue=e.catalogue,!("wishlist"in e&&e.wishlist instanceof s))throw Error("We need a Wishlist.");this.wishlist=e.wishlist,this.listenTo(this.collection,"currentChanged",function(e){this.catalogue.collection=e instanceof t?e.get("outfit"):null,this.catalogue.render()}.bind(this)),this.listenTo(this.catalogue,"addedToWishlist",function(e){this.wishlist.collection.add(e)}.bind(this))}});var h=new i,u=new a({collection:h,video:new n({collection:h,el:$("#playback").get(0),feed:$("#playback .video").get(0),playlist:new o({collection:h,el:$("#playback .playlist").get(0),container:$("#playback .playlist .items").get(0),template:$("#playback .playlist .items li").get(0)})}),catalogue:new c({el:$("#catalogue").get(0),container:$("#catalogue .items").get(0),template:$("#catalogue .items li").get(0)}),wishlist:new s({el:$("#wishlist").get(0),container:$("#wishlist .items").get(0),template:$("#wishlist .items li").get(0)})});(function(){var e,i,n=_.after(2,function(){var n;n=_.map(e,function(e){return e.outfit=new r,new t(e)}),_.each(i,function(e){var t,i=e.outfits;delete e.outfits,t=new l(e),_.chain(n).filter(function(e){return _.contains(i,e.get("outfit_id"))}).each(function(e){e.get("outfit").add(t)})}),_.invoke(n,"unset","outfit_id"),h.reset(n)});$.ajax({url:"../data/videos.jsonp",type:"GET",dataType:"jsonp",success:function(t){e=t,n()}}),$.ajax({url:"../data/clothing.jsonp",type:"GET",dataType:"jsonp",success:function(e){i=e,n()}})})(),window.app=u})();